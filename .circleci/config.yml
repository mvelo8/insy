version: 2.1

orbs:
  node: circleci/node@5.1.0
  sonarcloud: sonarsource/sonarcloud@1.0.4

jobs:
  # Backend Tests
  backend-test:
    docker:
      - image: circleci/node:18
      - image: circleci/mongo:6.0
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: backend
      - run:
          name: Run security audit
          command: |
            cd backend
            npm audit --audit-level=moderate
            npx snyk test --all-projects
      - run:
          name: Run backend tests
          command: |
            cd backend
            npm test
      - run:
          name: Generate test coverage
          command: |
            cd backend
            npm run test:coverage

  # Frontend Tests
  frontend-test:
    docker:
      - image: circleci/node:18
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: frontend
      - run:
          name: Run security audit
          command: |
            cd frontend
            npm audit --audit-level=moderate
            npx snyk test --all-projects
      - run:
          name: Run frontend tests
          command: |
            cd frontend
            npm test -- --coverage --watchAll=false
      - run:
          name: Build frontend
          command: |
            cd frontend
            npm run build

  # Docker Build
  docker-build:
    docker:
      - image: circleci/node:18
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build Docker images
          command: |
            docker build -t international-payments-api:latest -f backend/Dockerfile ./backend
            docker build -t international-payments-frontend:latest -f frontend/Dockerfile ./frontend
      - run:
          name: Scan Docker images for vulnerabilities
          command: |
            docker scan international-payments-api:latest
            docker scan international-payments-frontend:latest

  # SonarQube Analysis
  sonar-analysis:
    docker:
      - image: circleci/node:18
    steps:
      - checkout
      - sonarcloud/scan

workflows:
  security-pipeline:
    jobs:
      - backend-test
      - frontend-test
      - docker-build:
          requires:
            - backend-test
            - frontend-test
      - sonar-analysis:
          requires:
            - backend-test
            - frontend-test
          context: sonarcloud